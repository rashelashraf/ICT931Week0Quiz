<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Assessment Quiz</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-dark: #0f1419;
            --bg-card: #1a1f26;
            --bg-input: #252b33;
            --accent-primary: #00d9a5;
            --accent-secondary: #00b386;
            --accent-warning: #ff6b6b;
            --accent-correct: #00d9a5;
            --accent-wrong: #ff6b6b;
            --text-primary: #ffffff;
            --text-secondary: #8899a6;
            --text-muted: #5c6d7e;
            --border-color: #2f3842;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--bg-card) 0%, #1e252d 100%);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-primary), #00ffcc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .week-badge {
            display: inline-block;
            background: var(--accent-primary);
            color: var(--bg-dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .question-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-input);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 16px;
            font-family: 'Space Mono', monospace;
        }

        .question-type {
            background: var(--accent-primary);
            color: var(--bg-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 14px;
            background: var(--bg-input);
            padding: 16px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .option-item:hover:not(.disabled) {
            background: #2a323c;
            border-color: var(--accent-primary);
        }

        .option-item.selected {
            background: rgba(0, 217, 165, 0.1);
            border-color: var(--accent-primary);
        }

        .option-item.correct {
            background: rgba(0, 217, 165, 0.15);
            border-color: var(--accent-correct);
        }

        .option-item.wrong {
            background: rgba(255, 107, 107, 0.15);
            border-color: var(--accent-wrong);
        }

        .option-item.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .option-radio, .option-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .option-checkbox {
            border-radius: 6px;
        }

        .option-item.selected .option-radio,
        .option-item.selected .option-checkbox {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
        }

        .option-item.selected .option-radio::after,
        .option-item.selected .option-checkbox::after {
            content: '‚úì';
            color: var(--bg-dark);
            font-weight: bold;
            font-size: 12px;
        }

        .option-text {
            flex: 1;
            font-size: 1rem;
        }

        .fill-blank-input {
            width: 100%;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s ease;
        }

        .fill-blank-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(0, 217, 165, 0.1);
        }

        .fill-blank-input:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-dark);
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 24px;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 217, 165, 0.3);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .submit-btn.secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .submit-btn.secondary:hover:not(:disabled) {
            background: #2a323c;
            box-shadow: none;
        }

        .feedback {
            margin-top: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .feedback.submitted {
            background: rgba(0, 217, 165, 0.1);
            color: var(--accent-primary);
            border: 1px solid var(--accent-primary);
        }

        /* Connection status */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
        }

        .connection-status.connected {
            background: rgba(0, 217, 165, 0.2);
            color: var(--accent-correct);
        }

        .connection-status.disconnected {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-wrong);
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 8px;
            padding: 16px 20px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            align-items: center;
        }

        .nav-tab {
            padding: 10px 20px;
            background: var(--bg-input);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-family: 'DM Sans', sans-serif;
        }

        .nav-tab:hover {
            background: #2a323c;
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--accent-primary);
            color: var(--bg-dark);
        }

        .week-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            padding-left: 20px;
            border-left: 1px solid var(--border-color);
        }

        .week-selector label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .week-selector select {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-family: 'DM Sans', sans-serif;
            font-weight: 600;
            cursor: pointer;
        }

        .week-selector select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        /* Dashboard */
        .dashboard {
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'Space Mono', monospace;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .responses-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .responses-table th,
        .responses-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .responses-table th {
            background: var(--bg-input);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .responses-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.correct {
            background: rgba(0, 217, 165, 0.2);
            color: var(--accent-correct);
        }

        .status-badge.wrong {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-wrong);
        }

        /* Student summary table */
        .student-summary-table {
            width: 100%;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 32px;
        }

        .student-summary-table th,
        .student-summary-table td {
            padding: 12px 14px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .student-summary-table th {
            background: var(--bg-input);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .student-summary-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .student-summary-table tr:last-child td {
            border-bottom: none;
        }

        .cell-correct { color: var(--accent-correct); }
        .cell-wrong { color: var(--accent-wrong); }
        .cell-pending { color: var(--text-muted); }

        /* QR Codes */
        .qr-generator {
            padding: 20px;
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .qr-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .qr-card.special {
            border: 2px dashed var(--accent-primary);
            background: rgba(0, 217, 165, 0.05);
        }

        .qr-card h3 {
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .qr-card .question-preview {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            height: 32px;
            overflow: hidden;
            line-height: 1.3;
        }

        .qr-code-container {
            background: white;
            padding: 12px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .qr-url {
            font-family: 'Space Mono', monospace;
            font-size: 0.6rem;
            color: var(--text-muted);
            word-break: break-all;
            margin-bottom: 8px;
        }

        .url-input-section {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .url-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .url-input-section input {
            width: 100%;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
        }

        .url-input-section input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .download-btn {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-dark);
        }

        .clear-btn {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid var(--accent-wrong);
            color: var(--accent-wrong);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'DM Sans', sans-serif;
        }

        .clear-btn:hover {
            background: var(--accent-wrong);
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Password & Name Input Overlays */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 20, 25, 0.98);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .overlay-card {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 16px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .overlay-card h2 {
            margin-bottom: 8px;
        }

        .overlay-card p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .overlay-card input {
            width: 100%;
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
            font-family: 'DM Sans', sans-serif;
        }

        .overlay-card input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .overlay-card .error-msg {
            color: var(--accent-wrong);
            font-size: 0.85rem;
            margin-bottom: 12px;
        }

        /* Setup Card */
        .setup-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .setup-card h2 {
            margin-bottom: 16px;
            color: var(--accent-primary);
        }

        .setup-card ol {
            padding-left: 20px;
            color: var(--text-secondary);
        }

        .setup-card li {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .setup-card code {
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            color: var(--accent-primary);
        }

        .setup-card .warning {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid var(--accent-wrong);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
            color: var(--accent-wrong);
            font-size: 0.9rem;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 217, 165, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--accent-primary);
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .logout-btn:hover {
            border-color: var(--accent-wrong);
            color: var(--accent-wrong);
        }

        /* Student Results Page */
        .results-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .results-card .student-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .results-card .results-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: var(--bg-input);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            border: 4px solid var(--accent-primary);
        }

        .score-circle.low {
            border-color: var(--accent-wrong);
        }

        .score-circle.medium {
            border-color: #ffc107;
        }

        .score-circle .score-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
            color: var(--accent-primary);
        }

        .score-circle.low .score-value {
            color: var(--accent-wrong);
        }

        .score-circle.medium .score-value {
            color: #ffc107;
        }

        .score-circle .score-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .results-details {
            text-align: left;
            margin-top: 24px;
        }

        .results-details h3 {
            margin-bottom: 16px;
            font-size: 1rem;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .result-item .result-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .result-item .result-icon.correct {
            background: rgba(0, 217, 165, 0.2);
            color: var(--accent-correct);
        }

        .result-item .result-icon.wrong {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-wrong);
        }

        .result-item .result-icon.pending {
            background: var(--bg-dark);
            color: var(--text-muted);
        }

        .result-item .result-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .result-item .result-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'Space Mono', monospace;
        }

        .no-results-msg {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-muted);
        }

        @media (max-width: 600px) {
            .header h1 { font-size: 1.5rem; }
            .question-card { padding: 24px; }
            .question-text { font-size: 1.1rem; }
            .nav-tabs { padding: 12px; flex-wrap: wrap; }
            .nav-tab { padding: 8px 14px; font-size: 0.9rem; }
            .week-selector { margin-left: 0; padding-left: 0; border-left: none; margin-top: 10px; width: 100%; }
            .student-summary-table { font-size: 0.7rem; }
            .student-summary-table th, .student-summary-table td { padding: 8px 4px; }
            .qr-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
            .score-circle { width: 120px; height: 120px; }
            .score-circle .score-value { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <div id="connection-status" class="connection-status disconnected" style="display: none;">‚ö´ Connecting...</div>
    <div id="app"></div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        
        // üîê TEACHER PASSWORD - Change this!
        const TEACHER_PASSWORD = "teacher123";

        // üî• FIREBASE CONFIG - Replace with your credentials
        const firebaseConfig = {
            apiKey: "AIzaSyDeUk5gl2l-7IxZpgQORzVJOQOIPJNun_A",
            authDomain: "ict931quiz.firebaseapp.com",
            projectId: "ict931quiz",
            storageBucket: "ict931quiz.firebasestorage.app",
            messagingSenderId: "1091766957063",
            appId: "1:1091766957063:web:325ae9325c3ae299e5e6a2",
            measurementId: "G-C7JH0PZFG2",
            databaseURL: "https://ict931quiz-default-rtdb.firebaseio.com"
        };

        // =============================================
        // QUIZ DATA - 10 WEEKS
        // =============================================
        const allQuizData = {
            1: {
                title: "Week 1: Introduction to Risk Assessment",
                subtitle: "Fundamentals and key concepts",
                questions: [
                {
                        id: 1,
                        type: "single",
                        question: "Information security is primarily concerned with protecting which three elements?",
                        options: [
                            "Authentication, Authorization, Accounting",
                            "Confidentiality, Integrity, Availability",
                            "Privacy, Usability, Accessibility",
                            "Hardware, Software, Network"
                        ],
                        correct: 1
                    },
                    {
                        id: 2,
                        type: "truefalse",
                        question: "A threat is a flaw or weakness in a system that can be exploited.",
                        correct: false
                    },
                    {
                        id: 3,
                        type: "single",
                        question: "A vulnerability is best described as:",
                        options: [
                            "A person attempting an attack",
                            "A flaw or weakness that can be exploited",
                            "A countermeasure to prevent attacks",
                            "A completed security breach"
                        ],
                        correct: 1
                    },
                    {
                        id: 4,
                        type: "multiple",
                        question: "Which of the following are key stages of risk identification? (Select all that apply)",
                        options: [
                            "Identify information assets",
                            "Classify and categorize assets",
                            "Eliminate all threats immediately",
                            "Prioritize assets by importance"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "Risk management is the process of identifying and _______ the risks to information assets.",
                        correct: ["controlling", "Control", "control"]
                    },
                    {
                        id: 6,
                        type: "single",
                        question: "Which document focuses on identifying, classifying, responding to, and recovering from incidents?",
                        options: [
                            "Business Continuity Plan (BCP)",
                            "Incident Response Plan (IRP)",
                            "Enterprise Information Security Policy (EISP)",
                            "Risk Rating Worksheet"
                        ],
                        correct: 1
                    },
                    {
                        id: 7,
                        type: "single",
                        question: "Which risk control approach involves shifting risk to another organization, such as through insurance?",
                        options: [
                            "Defense",
                            "Mitigation",
                            "Transferal",
                            "Termination"
                        ],
                        correct: 2
                    },
                    {
                        id: 8,
                        type: "truefalse",
                        question: "The Disaster Recovery Plan (DRP) focuses on restoring systems after a disaster.",
                        correct: true
                    },
                    {
                        id: 9,
                        type: "single",
                        question: "Enterprise Information Security Policy (EISP) is primarily:",
                        options: [
                            "A technical configuration document",
                            "An executive-level strategic security document",
                            "A daily operational checklist",
                            "A disaster recovery manual"
                        ],
                        correct: 1
                    },
                    {
                        id: 10,
                        type: "multiple",
                        question: "Contingency planning includes which of the following components? (Select all that apply)",
                        options: [
                            "Business Impact Analysis (BIA)",
                            "Incident Response Plan (IRP)",
                            "Disaster Recovery Plan (DRP)",
                            "Business Continuity Plan (BCP)"
                        ],
                        correct: [0, 1, 2, 3]
                    },
                    {
                        id: 11,
                        type: "fillblank",
                        question: "Supplier orders (outbound) is evaluated as an information asset. If the weighted criteria are: impact on revenue (30%) = 0.8, impact on profitability (40%) = 0.9, and impact on public image (30%) = 0.6, what is the overall weighted score out of 100?",
                        correct: ["78", "78.0", "78%"]
                    },
                    {
                        id: 12,
                        type: "fillblank",
                        question: "Customer service requests via e-mail (inbound) experience disruption due to hardware failure. If the likelihood is rated as 2 and the impact is rated as 3, the calculated risk rating factor is _______.",
                        correct: ["6", "6.0"]
                    },
                    {
                        id: 13,
                        type: "multiple",
                        question: "Which of the following are components of Contingency Planning (CP)? (Select all that apply)",
                        options: [
                            "Business Impact Analysis (BIA)",
                            "Incident Response Plan (IRP)",
                            "Disaster Recovery Plan (DRP)",
                            "Business Continuity Plan (BCP)",
                            "Contingency Plan (CP)"
                        ],
                        correct: [0, 1, 2, 3]
                    }
            
                ]
            },
            2: {
                title: "Week 2: Planning for Organizational Readiness",
                subtitle: "Planning for Organizational Readiness",
                questions: [
                    {
                        id: 1,
                        type: "multiple",
                        question: "Which of the following are elements required to begin the Contingency Planning (CP) process? (Select all that apply)",
                        options: [
                            "Contingency Planning Management Team (CPMT)",
                            "Business Impact Analysis (BIA)",
                            "Marketing Strategy Plan",
                            "Planning methodology",
                            "Access to financial resources"
                        ],
                        correct: [0, 1, 3, 4]
                    },
                    {
                        id: 2,
                        type: "single",
                        question: "Which team is primarily responsible for managing and conducting the overall CP process?",
                        options: [
                            "Risk Management (RM) Team",
                            "Contingency Planning Management Team (CPMT)",
                            "IT Help Desk",
                            "External Auditor"
                        ],
                        correct: 1
                    },
                    {
                        id: 3,
                        type: "truefalse",
                        question: "The purpose of the CP policy is to define the scope of CP operations and establish managerial intent.",
                        correct: true
                    },
                    {
                        id: 4,
                        type: "fillblank",
                        question: "The __________ is an investigation and assessment of the impact that various events or incidents can have on the organization.",
                        correct: ["Business Impact Analysis", "BIA", "business impact analysis"]
                    },
                    {
                        id: 5,
                        type: "multiple",
                        question: "Which of the following are stages of the CPMT‚Äôs Business Impact Analysis (BIA)? (Select all that apply)",
                        options: [
                            "Assessing mission/business processes and recovery criticality",
                            "Identifying resource requirements",
                            "Designing firewall rules",
                            "Identifying recovery priorities"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 6,
                        type: "fillblank",
                        question: "In weighted ranking of business processes, the sum of all criterion weights must equal __________.",
                        correct: ["1.0", "1"]
                    },
                    {
                        id: 7,
                        type: "single",
                        question: "If an online banking system crashes at 10:00 AM and must be restored by 2:00 PM, this requirement defines which metric?",
                        options: [
                            "Recovery Point Objective (RPO)",
                            "Recovery Time Objective (RTO)",
                            "Work Recovery Time (WRT)",
                            "Business Impact Analysis (BIA)"
                        ],
                        correct: 1
                    },
                    {
                        id: 8,
                        type: "single",
                        question: "Which downtime metric defines how long a system can be unavailable before serious business damage occurs?",
                        options: [
                            "Recovery Time Objective (RTO)",
                            "Recovery Point Objective (RPO)",
                            "Maximum Tolerable Downtime (MTD)",
                            "Work Recovery Time (WRT)"
                        ],
                        correct: 2
                    },
                    {
                        id: 9,
                        type: "truefalse",
                        question: "RTO must be shorter than MTD to avoid exceeding maximum tolerable downtime.",
                        correct: true
                    },
                    {
                        id: 10,
                        type: "single",
                        question: "According to the slides, what is the number one budgetary expense for Disaster Recovery (DR)?",
                        options: [
                            "Employee overtime",
                            "Insurance",
                            "Hardware redundancy",
                            "Staff training"
                        ],
                        correct: 1
                    }
                    ]
                },
            3: {
                title: "Week 3: Risk Evaluation",
                subtitle: "Assessing likelihood and severity",
                questions: [
                    {
                        id: 1,
                        type: "single",
                        question: "In a 5x5 risk matrix, what does the number represent?",
                        options: [
                            "Number of employees",
                            "Cost in thousands",
                            "Risk level (likelihood √ó severity)",
                            "Days of training required"
                        ],
                        correct: 2
                    },
                    {
                        id: 2,
                        type: "truefalse",
                        question: "High likelihood combined with high severity always results in an unacceptable risk.",
                        correct: true
                    },
                    {
                        id: 3,
                        type: "multiple",
                        question: "Which factors affect the LIKELIHOOD of a risk occurring? (Select all that apply)",
                        options: [
                            "Frequency of exposure",
                            "Existing control measures",
                            "Cost of equipment",
                            "Training level of workers"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 4,
                        type: "single",
                        question: "What does ALARP stand for?",
                        options: [
                            "As Low As Reasonably Practicable",
                            "Always Look At Risk Prevention",
                            "Assess Likelihood And Risk Potential",
                            "Alternative Low-risk Action Plan"
                        ],
                        correct: 0
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "The potential consequences of a hazard are called its _______.",
                        correct: ["severity", "Severity", "SEVERITY"]
                    }
                ]
            },
            4: {
                title: "Week 4: Hierarchy of Controls",
                subtitle: "Control measures from most to least effective",
                questions: [
                    {
                        id: 1,
                        type: "single",
                        question: "In the hierarchy of controls, which is MOST effective?",
                        options: [
                            "Personal Protective Equipment",
                            "Administrative Controls",
                            "Engineering Controls",
                            "Elimination"
                        ],
                        correct: 3
                    },
                    {
                        id: 2,
                        type: "single",
                        question: "Installing a machine guard is an example of:",
                        options: [
                            "Elimination",
                            "Substitution",
                            "Engineering Controls",
                            "Administrative Controls"
                        ],
                        correct: 2
                    },
                    {
                        id: 3,
                        type: "truefalse",
                        question: "PPE should be the first line of defense against workplace hazards.",
                        correct: false
                    },
                    {
                        id: 4,
                        type: "multiple",
                        question: "Which are examples of administrative controls? (Select all that apply)",
                        options: [
                            "Job rotation",
                            "Safety training",
                            "Installing ventilation",
                            "Warning signs"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "Replacing a toxic chemical with a safer alternative is called _______.",
                        correct: ["substitution", "Substitution", "SUBSTITUTION"]
                    }
                ]
            },
            5: {
                title: "Week 5: Documentation & Recording",
                subtitle: "Proper record keeping",
                questions: [
                    {
                        id: 1,
                        type: "truefalse",
                        question: "Risk assessments must always be documented in writing.",
                        correct: true
                    },
                    {
                        id: 2,
                        type: "multiple",
                        question: "What should a risk assessment document include? (Select all that apply)",
                        options: [
                            "Identified hazards",
                            "Employee salaries",
                            "Control measures implemented",
                            "Review dates"
                        ],
                        correct: [0, 2, 3]
                    },
                    {
                        id: 3,
                        type: "single",
                        question: "How long should risk assessment records typically be retained?",
                        options: [
                            "1 month",
                            "1 year",
                            "At least 3-5 years or as required by law",
                            "Records don't need to be kept"
                        ],
                        correct: 2
                    },
                    {
                        id: 4,
                        type: "single",
                        question: "Who should have access to risk assessment documents?",
                        options: [
                            "Only senior management",
                            "Only the safety officer",
                            "Relevant employees and stakeholders",
                            "No one - they are confidential"
                        ],
                        correct: 2
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "A written record of a workplace incident is called an _______ report.",
                        correct: ["incident", "Incident", "INCIDENT", "accident", "Accident"]
                    }
                ]
            },
            6: {
                title: "Week 6: Legal Requirements",
                subtitle: "Regulatory compliance",
                questions: [
                    {
                        id: 1,
                        type: "truefalse",
                        question: "Employers have a legal duty to conduct risk assessments.",
                        correct: true
                    },
                    {
                        id: 2,
                        type: "single",
                        question: "Under most health and safety laws, who has the PRIMARY responsibility for workplace safety?",
                        options: [
                            "Employees only",
                            "The government",
                            "The employer",
                            "Insurance companies"
                        ],
                        correct: 2
                    },
                    {
                        id: 3,
                        type: "multiple",
                        question: "Employees have duties to: (Select all that apply)",
                        options: [
                            "Follow safety procedures",
                            "Report hazards",
                            "Conduct their own risk assessments",
                            "Use provided safety equipment properly"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 4,
                        type: "single",
                        question: "Failure to comply with health and safety regulations can result in:",
                        options: [
                            "Only verbal warnings",
                            "Fines, prosecution, or imprisonment",
                            "Tax benefits",
                            "Nothing significant"
                        ],
                        correct: 1
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "A _______ competent person should conduct or oversee risk assessments.",
                        correct: ["competent", "Competent", "trained", "Trained", "qualified", "Qualified"]
                    }
                ]
            },
            7: {
                title: "Week 7: Specific Hazard Types",
                subtitle: "Chemical, biological, and physical hazards",
                questions: [
                    {
                        id: 1,
                        type: "single",
                        question: "What does COSHH stand for?",
                        options: [
                            "Control of Substances Hazardous to Health",
                            "Company Occupational Safety and Health Handbook",
                            "Certified Occupational Safety and Health Handler",
                            "Complete Overview of Safety and Health Hazards"
                        ],
                        correct: 0
                    },
                    {
                        id: 2,
                        type: "multiple",
                        question: "Which are examples of biological hazards? (Select all that apply)",
                        options: [
                            "Mold spores",
                            "Loud noise",
                            "Blood-borne pathogens",
                            "Electricity"
                        ],
                        correct: [0, 2]
                    },
                    {
                        id: 3,
                        type: "truefalse",
                        question: "Radiation is only a concern in nuclear facilities.",
                        correct: false
                    },
                    {
                        id: 4,
                        type: "single",
                        question: "Manual handling injuries are most commonly associated with:",
                        options: [
                            "Chemical burns",
                            "Back and musculoskeletal problems",
                            "Hearing loss",
                            "Eye strain"
                        ],
                        correct: 1
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "Safety Data Sheets (SDS) provide information about _______ substances.",
                        correct: ["chemical", "Chemical", "hazardous", "Hazardous"]
                    }
                ]
            },
            8: {
                title: "Week 8: Emergency Preparedness",
                subtitle: "Planning for emergencies",
                questions: [
                    {
                        id: 1,
                        type: "multiple",
                        question: "An emergency response plan should include: (Select all that apply)",
                        options: [
                            "Evacuation procedures",
                            "Emergency contact numbers",
                            "Employee vacation schedules",
                            "Assembly points"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 2,
                        type: "truefalse",
                        question: "Fire drills should be conducted at least annually.",
                        correct: true
                    },
                    {
                        id: 3,
                        type: "single",
                        question: "First aid equipment should be:",
                        options: [
                            "Locked away to prevent theft",
                            "Easily accessible and clearly marked",
                            "Only available to trained first aiders",
                            "Kept in the manager's office"
                        ],
                        correct: 1
                    },
                    {
                        id: 4,
                        type: "single",
                        question: "Who should be trained in emergency procedures?",
                        options: [
                            "Only managers",
                            "Only safety officers",
                            "All employees",
                            "Only new employees"
                        ],
                        correct: 2
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "A designated meeting location after evacuation is called an _______ point.",
                        correct: ["assembly", "Assembly", "ASSEMBLY", "muster", "Muster"]
                    }
                ]
            },
            9: {
                title: "Week 9: Monitoring & Review",
                subtitle: "Continuous improvement",
                questions: [
                    {
                        id: 1,
                        type: "single",
                        question: "How often should risk assessments be reviewed?",
                        options: [
                            "Never - they are permanent",
                            "Only after accidents",
                            "Regularly and when circumstances change",
                            "Every 10 years"
                        ],
                        correct: 2
                    },
                    {
                        id: 2,
                        type: "multiple",
                        question: "What might trigger a risk assessment review? (Select all that apply)",
                        options: [
                            "New equipment introduced",
                            "An incident or near-miss",
                            "Employee birthday",
                            "Changes in legislation"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 3,
                        type: "truefalse",
                        question: "Leading indicators predict potential problems before they occur.",
                        correct: true
                    },
                    {
                        id: 4,
                        type: "single",
                        question: "Which is a lagging indicator?",
                        options: [
                            "Safety training completion rates",
                            "Number of safety inspections",
                            "Injury and illness rates",
                            "Near-miss reports submitted"
                        ],
                        correct: 2
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "The process of continuous improvement is often called the Plan-Do-_______-Act cycle.",
                        correct: ["Check", "check", "CHECK"]
                    }
                ]
            },
            10: {
                title: "Week 10: Comprehensive Review",
                subtitle: "Final assessment covering all topics",
                questions: [
                    {
                        id: 1,
                        type: "single",
                        question: "The hierarchy of controls lists elimination as the MOST effective because:",
                        options: [
                            "It's the cheapest option",
                            "It completely removes the hazard",
                            "It requires no training",
                            "It's legally required first"
                        ],
                        correct: 1
                    },
                    {
                        id: 2,
                        type: "multiple",
                        question: "Who has responsibilities in workplace risk management? (Select all that apply)",
                        options: [
                            "Employers",
                            "Employees",
                            "Only external consultants",
                            "Contractors and visitors"
                        ],
                        correct: [0, 1, 3]
                    },
                    {
                        id: 3,
                        type: "truefalse",
                        question: "Risk assessments should consider both physical and psychological hazards.",
                        correct: true
                    },
                    {
                        id: 4,
                        type: "single",
                        question: "PPE stands for:",
                        options: [
                            "Primary Prevention Equipment",
                            "Personal Protective Equipment",
                            "Professional Protection Essentials",
                            "Protective Personnel Evaluation"
                        ],
                        correct: 1
                    },
                    {
                        id: 5,
                        type: "fillblank",
                        question: "Risk = Likelihood √ó _______",
                        correct: ["Severity", "severity", "SEVERITY", "consequence", "Consequence"]
                    }
                ]
            }
        };

        // =============================================
        // FIREBASE INITIALIZATION
        // =============================================
        const isFirebaseConfigured = firebaseConfig.apiKey !== "YOUR_API_KEY";
        let db = null;

        if (isFirebaseConfigured) {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                
                db.ref('.info/connected').on('value', (snap) => {
                    const statusEl = document.getElementById('connection-status');
                    if (snap.val() === true) {
                        statusEl.className = 'connection-status connected';
                        statusEl.innerHTML = 'üü¢ Live';
                    } else {
                        statusEl.className = 'connection-status disconnected';
                        statusEl.innerHTML = 'üî¥ Offline';
                    }
                });
            } catch (e) {
                console.error('Firebase init error:', e);
            }
        }

        // =============================================
        // APP STATE
        // =============================================
        let state = {
            view: 'quiz',
            currentWeek: 1,
            currentQuestion: null,
            studentName: localStorage.getItem('quiz_student_name') || '',
            selectedAnswers: {},
            submitted: {},
            responses: [],
            studentResults: [], // For student results page
            baseUrl: window.location.origin + window.location.pathname,
            isTeacher: false,
            isAuthenticated: sessionStorage.getItem('teacher_auth') === 'true',
            passwordError: false,
            loadingResults: false
        };

        // Parse URL
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const week = parseInt(params.get('week')) || 1;
            const q = params.get('q');
            const view = params.get('view');

            state.currentWeek = Math.min(Math.max(week, 1), 10);

            if (view === 'dashboard') {
                state.view = 'dashboard';
                state.isTeacher = true;
            } else if (view === 'qr') {
                state.view = 'qrcodes';
                state.isTeacher = true;
            } else if (view === 'results') {
                state.view = 'results';
                state.isTeacher = false;
            } else if (q) {
                const qNum = parseInt(q);
                const weekData = allQuizData[state.currentWeek];
                if (weekData && qNum >= 1 && qNum <= weekData.questions.length) {
                    state.currentQuestion = qNum;
                    state.view = 'quiz';
                    state.isTeacher = false;
                }
            } else {
                state.view = 'landing';
            }
        }

        parseUrlParams();

        // =============================================
        // FIREBASE FUNCTIONS
        // =============================================
        function getResponsesRef(week) {
            return db ? db.ref(`quiz_responses/week_${week}`) : null;
        }

        function saveResponse(response) {
            if (!isFirebaseConfigured || !db) {
                alert('Quiz is in demo mode. Configure Firebase to save responses.');
                return;
            }
            const ref = getResponsesRef(state.currentWeek);
            if (ref) {
                ref.push().set({
                    ...response,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function listenToResponses() {
            if (!isFirebaseConfigured || !db) return;
            const ref = getResponsesRef(state.currentWeek);
            if (ref) {
                ref.off();
                ref.orderByChild('timestamp').on('value', (snapshot) => {
                    const responses = [];
                    snapshot.forEach((child) => {
                        responses.push({ id: child.key, ...child.val() });
                    });
                    state.responses = responses;
                    if (state.view === 'dashboard') render();
                });
            }
        }

        function loadStudentResults() {
            if (!isFirebaseConfigured || !db || !state.studentName) {
                state.loadingResults = false;
                render();
                return;
            }
            
            state.loadingResults = true;
            render();

            const ref = getResponsesRef(state.currentWeek);
            if (ref) {
                ref.orderByChild('studentName').equalTo(state.studentName).once('value', (snapshot) => {
                    const results = [];
                    snapshot.forEach((child) => {
                        results.push({ id: child.key, ...child.val() });
                    });
                    // Sort by question ID
                    results.sort((a, b) => a.questionId - b.questionId);
                    state.studentResults = results;
                    state.loadingResults = false;
                    render();
                });
            }
        }

        function clearWeekResponses() {
            if (!isFirebaseConfigured || !db) return;
            const ref = getResponsesRef(state.currentWeek);
            if (ref) ref.remove();
        }

        // =============================================
        // RENDER FUNCTIONS
        // =============================================
        function render() {
            const app = document.getElementById('app');
            const statusEl = document.getElementById('connection-status');

            // Handle teacher authentication
            if (state.isTeacher && !state.isAuthenticated) {
                app.innerHTML = renderPasswordPrompt();
                statusEl.style.display = 'none';
                attachEventListeners();
                return;
            }

            statusEl.style.display = (state.view === 'dashboard' || state.view === 'quiz' || state.view === 'results') ? 'block' : 'none';

            if (!isFirebaseConfigured && state.isTeacher) {
                app.innerHTML = renderSetupInstructions();
            } else if (state.view === 'dashboard') {
                listenToResponses();
                app.innerHTML = renderDashboard();
            } else if (state.view === 'qrcodes') {
                app.innerHTML = renderQRCodes();
                setTimeout(generateQRCodes, 100);
            } else if (state.view === 'results') {
                app.innerHTML = renderStudentResults();
            } else if (state.view === 'landing') {
                app.innerHTML = renderLanding();
            } else if (state.view === 'quiz') {
                if (!state.studentName) {
                    app.innerHTML = renderNameInput();
                } else {
                    app.innerHTML = renderQuiz();
                }
            }

            attachEventListeners();
        }

        function renderPasswordPrompt() {
            return `
                <div class="overlay">
                    <div class="overlay-card">
                        <h2>üîê Teacher Access</h2>
                        <p>Enter the teacher password to continue</p>
                        ${state.passwordError ? '<p class="error-msg">Incorrect password. Try again.</p>' : ''}
                        <input type="password" id="passwordInput" placeholder="Password" autofocus>
                        <button class="submit-btn" id="passwordSubmitBtn">Enter</button>
                        <p style="margin-top: 20px; font-size: 0.8rem; color: var(--text-muted);">
                            <a href="?" style="color: var(--accent-primary);">‚Üê Back to student view</a>
                        </p>
                    </div>
                </div>
            `;
        }

        function renderNavTabs() {
            if (!state.isTeacher) return '';

            return `
                <nav class="nav-tabs">
                    <button class="nav-tab ${state.view === 'dashboard' ? 'active' : ''}" data-view="dashboard">
                        üìä Dashboard
                    </button>
                    <button class="nav-tab ${state.view === 'qrcodes' ? 'active' : ''}" data-view="qrcodes">
                        üì± QR Codes
                    </button>
                    <div class="week-selector">
                        <label>Week:</label>
                        <select id="weekSelect">
                            ${Object.keys(allQuizData).map(w => `
                                <option value="${w}" ${parseInt(w) === state.currentWeek ? 'selected' : ''}>
                                    Week ${w}
                                </option>
                            `).join('')}
                        </select>
                        <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
                    </div>
                </nav>
            `;
        }

        function renderSetupInstructions() {
            return `
                ${renderNavTabs()}
                <div class="header">
                    <h1>‚öôÔ∏è Firebase Setup Required</h1>
                    <p class="subtitle">Configure Firebase for live response tracking</p>
                </div>
                <div class="container">
                    <div class="setup-card">
                        <h2>üìã Quick Setup Guide (5 minutes)</h2>
                        <ol>
                            <li>Go to <a href="https://console.firebase.google.com/" target="_blank" style="color: var(--accent-primary);">Firebase Console</a></li>
                            <li>Click <strong>"Create a project"</strong></li>
                            <li>Once created, click the <strong>Web icon (&lt;/&gt;)</strong> to add a web app</li>
                            <li>Copy your <code>firebaseConfig</code> object</li>
                            <li>Go to <strong>Build ‚Üí Realtime Database ‚Üí Create Database</strong></li>
                            <li>Choose <strong>"Start in test mode"</strong></li>
                            <li>Edit this HTML file and replace the <code>firebaseConfig</code> values</li>
                            <li>Also change the <code>TEACHER_PASSWORD</code> at the top of the script!</li>
                        </ol>
                        <div class="warning">
                            ‚ö†Ô∏è Default password is "teacher123" - change it before deploying!
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLanding() {
            return `
                <div class="header">
                    <h1>Risk Assessment Quiz</h1>
                    <p class="subtitle">Workplace Safety Training</p>
                </div>
                <div class="container">
                    <div class="question-card" style="text-align: center;">
                        <div class="empty-state-icon">üì±</div>
                        <h2 style="margin-bottom: 16px;">Scan a QR Code to Begin</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">
                            Each question has its own QR code. Scan the code shown on the presentation slide to answer that specific question.
                        </p>
                        <div style="border-top: 1px solid var(--border-color); padding-top: 24px; margin-top: 24px;">
                            <p style="color: var(--text-muted); font-size: 0.9rem;">
                                Are you a teacher? 
                                <a href="?view=dashboard" style="color: var(--accent-primary);">Open Dashboard</a>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNameInput() {
            const weekData = allQuizData[state.currentWeek];
            const question = weekData?.questions.find(q => q.id === state.currentQuestion);
            const isResultsView = state.view === 'results';
            
            return `
                <div class="overlay">
                    <div class="overlay-card">
                        <div class="week-badge">Week ${state.currentWeek}</div>
                        <h2>Welcome! üëã</h2>
                        ${isResultsView 
                            ? '<p>Enter your name to view your results</p>'
                            : `<p>Question ${state.currentQuestion}: ${question ? question.question.substring(0, 50) + '...' : ''}</p>`
                        }
                        <input type="text" id="studentNameInput" placeholder="Enter your name" autofocus>
                        <button class="submit-btn" id="startQuizBtn">Continue</button>
                    </div>
                </div>
            `;
        }

        function renderQuiz() {
            const weekData = allQuizData[state.currentWeek];
            const question = weekData?.questions.find(q => q.id === state.currentQuestion);
            
            if (!question) {
                return `
                    <div class="header">
                        <div class="week-badge">Week ${state.currentWeek}</div>
                        <h1>${weekData?.title || 'Quiz'}</h1>
                    </div>
                    <div class="container">
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ùì</div>
                            <p>Invalid question. Please scan a valid QR code.</p>
                        </div>
                    </div>
                `;
            }

            const key = `${state.currentWeek}-${state.currentQuestion}`;
            const isSubmitted = state.submitted[key];

            return `
                <div class="header">
                    <div class="week-badge">Week ${state.currentWeek}</div>
                    <h1>${weekData.title}</h1>
                    <p class="subtitle">Answering as: <strong>${state.studentName}</strong></p>
                </div>
                <div class="container">
                    ${renderQuestion(question)}
                    ${isSubmitted ? `
                        <div class="question-card" style="text-align: center;">
                            <p style="margin-bottom: 16px; color: var(--text-secondary);">Want to see your overall score for this week?</p>
                            <a href="?week=${state.currentWeek}&view=results" class="submit-btn" style="display: inline-block; text-decoration: none;">
                                üìä View My Results
                            </a>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderQuestion(question) {
            const key = `${state.currentWeek}-${question.id}`;
            const isSubmitted = state.submitted[key];

            let typeLabel = '';
            switch(question.type) {
                case 'single': typeLabel = 'Single Choice'; break;
                case 'multiple': typeLabel = 'Multiple Choice'; break;
                case 'truefalse': typeLabel = 'True/False'; break;
                case 'fillblank': typeLabel = 'Fill in the Blank'; break;
            }

            let optionsHtml = '';

            if (question.type === 'single' || question.type === 'multiple') {
                const isMultiple = question.type === 'multiple';
                const selected = state.selectedAnswers[key] || (isMultiple ? [] : null);

                optionsHtml = `
                    <div class="options-list">
                        ${question.options.map((opt, idx) => {
                            let isSelected = isMultiple ? selected.includes(idx) : selected === idx;
                            let classes = 'option-item';
                            if (isSelected) classes += ' selected';
                            if (isSubmitted) classes += ' disabled';
                            return `
                                <div class="${classes}" data-option="${idx}" ${isSubmitted ? '' : 'data-clickable'}>
                                    <div class="${isMultiple ? 'option-checkbox' : 'option-radio'}"></div>
                                    <span class="option-text">${opt}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (question.type === 'truefalse') {
                const selected = state.selectedAnswers[key];
                optionsHtml = `
                    <div class="options-list">
                        ${[true, false].map(val => {
                            let isSelected = selected === val;
                            let classes = 'option-item';
                            if (isSelected) classes += ' selected';
                            if (isSubmitted) classes += ' disabled';
                            return `
                                <div class="${classes}" data-tf="${val}" ${isSubmitted ? '' : 'data-clickable'}>
                                    <div class="option-radio"></div>
                                    <span class="option-text">${val ? 'True' : 'False'}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else if (question.type === 'fillblank') {
                const value = state.selectedAnswers[key] || '';
                optionsHtml = `
                    <input 
                        type="text" 
                        class="fill-blank-input" 
                        id="fillBlankInput"
                        placeholder="Type your answer here..."
                        value="${value}"
                        ${isSubmitted ? 'disabled' : ''}
                    >
                `;
            }

            const hasAnswer = state.selectedAnswers[key] !== undefined && 
                              state.selectedAnswers[key] !== null &&
                              state.selectedAnswers[key] !== '' &&
                              (Array.isArray(state.selectedAnswers[key]) ? state.selectedAnswers[key].length > 0 : true);

            return `
                <div class="question-card">
                    <div class="question-badge">
                        Question ${question.id} of ${allQuizData[state.currentWeek].questions.length}
                        <span class="question-type">${typeLabel}</span>
                    </div>
                    <div class="question-text">${question.question}</div>
                    ${optionsHtml}
                    ${!isSubmitted ? `
                        <button class="submit-btn" id="submitAnswerBtn" ${!hasAnswer ? 'disabled' : ''}>
                            Submit Answer
                        </button>
                    ` : `
                        <div class="feedback submitted">
                            ‚úì Your answer has been submitted!
                        </div>
                    `}
                </div>
            `;
        }

        function renderStudentResults() {
            const weekData = allQuizData[state.currentWeek];

            // Check if student name is set
            if (!state.studentName) {
                return `
                    <div class="overlay">
                        <div class="overlay-card">
                            <div class="week-badge">Week ${state.currentWeek}</div>
                            <h2>View Your Results üìä</h2>
                            <p>Enter your name to see your score</p>
                            <input type="text" id="studentNameInput" placeholder="Enter your name" autofocus>
                            <button class="submit-btn" id="startQuizBtn">View Results</button>
                        </div>
                    </div>
                `;
            }

            // Loading state
            if (state.loadingResults) {
                return `
                    <div class="header">
                        <div class="week-badge">Week ${state.currentWeek}</div>
                        <h1>üìä Your Results</h1>
                    </div>
                    <div class="container">
                        <div class="results-card">
                            <p>Loading your results...</p>
                        </div>
                    </div>
                `;
            }

            const results = state.studentResults;
            const totalQuestions = weekData.questions.length;
            const answeredQuestions = results.length;
            const correctAnswers = results.filter(r => r.correct).length;
            const percentage = answeredQuestions > 0 ? Math.round((correctAnswers / answeredQuestions) * 100) : 0;

            // Determine score level for styling
            let scoreClass = '';
            if (percentage >= 70) scoreClass = '';
            else if (percentage >= 40) scoreClass = 'medium';
            else scoreClass = 'low';

            // Get attempt date/time
            const latestAttempt = results.length > 0 
                ? new Date(Math.max(...results.map(r => r.timestamp)))
                : null;

            return `
                <div class="header">
                    <div class="week-badge">Week ${state.currentWeek}</div>
                    <h1>üìä Your Results</h1>
                    <p class="subtitle">${weekData.title}</p>
                </div>
                <div class="container">
                    <div class="results-card">
                        <div class="student-name">üë§ ${state.studentName}</div>
                        <div class="results-date">
                            ${latestAttempt 
                                ? `Last attempt: ${latestAttempt.toLocaleDateString()} at ${latestAttempt.toLocaleTimeString()}`
                                : 'No attempts yet'
                            }
                        </div>

                        ${answeredQuestions > 0 ? `
                            <div class="score-circle ${scoreClass}">
                                <div class="score-value">${percentage}%</div>
                                <div class="score-label">${correctAnswers}/${answeredQuestions} correct</div>
                            </div>

                            <div class="stats-grid" style="margin-bottom: 0;">
                                <div class="stat-card">
                                    <div class="stat-value" style="font-size: 1.5rem;">${answeredQuestions}</div>
                                    <div class="stat-label">Answered</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" style="font-size: 1.5rem; color: var(--accent-correct);">${correctAnswers}</div>
                                    <div class="stat-label">Correct</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" style="font-size: 1.5rem; color: var(--accent-wrong);">${answeredQuestions - correctAnswers}</div>
                                    <div class="stat-label">Incorrect</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" style="font-size: 1.5rem; color: var(--text-muted);">${totalQuestions - answeredQuestions}</div>
                                    <div class="stat-label">Pending</div>
                                </div>
                            </div>

                            <div class="results-details">
                                <h3>Question Breakdown</h3>
                                ${weekData.questions.map(q => {
                                    const result = results.find(r => r.questionId === q.id);
                                    let statusClass = 'pending';
                                    let statusIcon = '‚Äî';
                                    let timeStr = '';

                                    if (result) {
                                        statusClass = result.correct ? 'correct' : 'wrong';
                                        statusIcon = result.correct ? '‚úì' : '‚úó';
                                        timeStr = new Date(result.timestamp).toLocaleTimeString();
                                    }

                                    return `
                                        <div class="result-item">
                                            <div class="result-icon ${statusClass}">${statusIcon}</div>
                                            <div class="result-text">
                                                <strong>Q${q.id}:</strong> ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}
                                            </div>
                                            ${timeStr ? `<div class="result-time">${timeStr}</div>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="no-results-msg">
                                <div class="empty-state-icon">üìù</div>
                                <p>You haven't answered any questions for Week ${state.currentWeek} yet.</p>
                                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 8px;">Scan a question QR code to start!</p>
                            </div>
                        `}
                    </div>

                    <div class="question-card" style="text-align: center;">
                        <button class="submit-btn secondary" id="changeNameBtn">
                            üîÑ Check Different Name
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const weekData = allQuizData[state.currentWeek];
            const responses = state.responses;
            
            const totalResponses = responses.length;
            const correctResponses = responses.filter(r => r.correct).length;
            const accuracy = totalResponses > 0 ? Math.round((correctResponses / totalResponses) * 100) : 0;
            const uniqueStudents = [...new Set(responses.map(r => r.studentName))];

            const byQuestion = {};
            responses.forEach(r => {
                if (!byQuestion[r.questionId]) byQuestion[r.questionId] = { correct: 0, wrong: 0 };
                if (r.correct) byQuestion[r.questionId].correct++;
                else byQuestion[r.questionId].wrong++;
            });

            const studentMatrix = {};
            uniqueStudents.forEach(name => { studentMatrix[name] = {}; });
            responses.forEach(r => { studentMatrix[r.studentName][r.questionId] = r.correct; });

            return `
                ${renderNavTabs()}
                <div class="header">
                    <div class="week-badge">Week ${state.currentWeek}</div>
                    <h1>üìä Teacher Dashboard</h1>
                    <p class="subtitle">
                        ${weekData.title}
                        <span class="live-indicator" style="margin-left: 12px;">
                            <span class="live-dot"></span> Live
                        </span>
                    </p>
                </div>
                <div class="dashboard container">
                    <div class="dashboard-header">
                        <h2>Response Statistics</h2>
                        <button class="clear-btn" id="clearBtn">üóëÔ∏è Clear Week ${state.currentWeek}</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalResponses}</div>
                            <div class="stat-label">Total Responses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${uniqueStudents.length}</div>
                            <div class="stat-label">Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${accuracy}%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${correctResponses}</div>
                            <div class="stat-label">Correct</div>
                        </div>
                    </div>

                    ${uniqueStudents.length > 0 ? `
                        <h3 style="margin-bottom: 16px;">üìã Student Results</h3>
                        <div style="overflow-x: auto; margin-bottom: 32px;">
                            <table class="student-summary-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        ${weekData.questions.map(q => `<th>Q${q.id}</th>`).join('')}
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${uniqueStudents.map(name => {
                                        const answers = studentMatrix[name];
                                        let correct = 0, answered = 0;
                                        return `
                                            <tr>
                                                <td>${name}</td>
                                                ${weekData.questions.map(q => {
                                                    if (answers[q.id] !== undefined) {
                                                        answered++;
                                                        if (answers[q.id]) correct++;
                                                        return `<td class="${answers[q.id] ? 'cell-correct' : 'cell-wrong'}">${answers[q.id] ? '‚úì' : '‚úó'}</td>`;
                                                    }
                                                    return `<td class="cell-pending">‚Äî</td>`;
                                                }).join('')}
                                                <td><strong>${correct}/${answered}</strong></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}

                    <h3 style="margin-bottom: 16px;">Question Performance</h3>
                    <div class="stats-grid" style="margin-bottom: 32px;">
                        ${weekData.questions.map(q => {
                            const stats = byQuestion[q.id] || { correct: 0, wrong: 0 };
                            const total = stats.correct + stats.wrong;
                            const pct = total > 0 ? Math.round((stats.correct / total) * 100) : 0;
                            const color = pct >= 70 ? 'var(--accent-correct)' : pct >= 40 ? '#ffc107' : 'var(--accent-wrong)';
                            return `
                                <div class="stat-card">
                                    <div class="stat-value" style="font-size: 1.5rem; color: ${color};">${pct}%</div>
                                    <div class="stat-label">Q${q.id}: ${total} responses</div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <h3 style="margin-bottom: 16px;">Recent Responses</h3>
                    ${responses.length > 0 ? `
                        <div style="overflow-x: auto;">
                            <table class="responses-table">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Student</th>
                                        <th>Q#</th>
                                        <th>Answer</th>
                                        <th>Result</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${responses.slice().reverse().slice(0, 30).map(r => `
                                        <tr>
                                            <td style="font-family: 'Space Mono', monospace; font-size: 0.75rem;">
                                                ${r.timestamp ? new Date(r.timestamp).toLocaleTimeString() : 'N/A'}
                                            </td>
                                            <td>${r.studentName}</td>
                                            <td>Q${r.questionId}</td>
                                            <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                ${formatAnswer(r.answer)}
                                            </td>
                                            <td>
                                                <span class="status-badge ${r.correct ? 'correct' : 'wrong'}">
                                                    ${r.correct ? '‚úì' : '‚úó'}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No responses yet for Week ${state.currentWeek}. Share the QR codes with students!</p>
                        </div>
                    `}
                </div>
            `;
        }

        function formatAnswer(answer) {
            if (Array.isArray(answer)) return answer.map(a => String.fromCharCode(65 + a)).join(', ');
            if (typeof answer === 'boolean') return answer ? 'True' : 'False';
            if (typeof answer === 'number') return String.fromCharCode(65 + answer);
            return answer;
        }

        function renderQRCodes() {
            const weekData = allQuizData[state.currentWeek];

            return `
                ${renderNavTabs()}
                <div class="header">
                    <div class="week-badge">Week ${state.currentWeek}</div>
                    <h1>üì± QR Code Generator</h1>
                    <p class="subtitle">${weekData.title}</p>
                </div>
                <div class="qr-generator container">
                    <div class="url-input-section">
                        <label>Base URL (where you host this quiz):</label>
                        <input type="text" id="baseUrlInput" value="${state.baseUrl}" placeholder="https://yoursite.com/quiz.html">
                        <button class="submit-btn" style="margin-top: 16px;" id="regenerateQRBtn">
                            Generate QR Codes
                        </button>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 12px;">
                            üí° Each QR links to one question. Students cannot navigate between questions.
                        </p>
                    </div>

                    <div class="qr-grid" id="qrGrid">
                        ${weekData.questions.map(q => `
                            <div class="qr-card">
                                <h3>Week ${state.currentWeek} - Q${q.id}</h3>
                                <p class="question-preview">${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}</p>
                                <div class="qr-code-container" id="qr-${q.id}"></div>
                                <div class="qr-url" id="url-${q.id}"></div>
                                <button class="download-btn" data-qr="${q.id}">‚¨áÔ∏è Download</button>
                            </div>
                        `).join('')}
                        
                        <div class="qr-card special">
                            <h3>üìä Student Results</h3>
                            <p class="question-preview">Students can view their score, name & attempt times</p>
                            <div class="qr-code-container" id="qr-results"></div>
                            <div class="qr-url" id="url-results"></div>
                            <button class="download-btn" data-qr="results">‚¨áÔ∏è Download</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateQRCodes() {
            const baseUrl = document.getElementById('baseUrlInput')?.value || state.baseUrl;
            const weekData = allQuizData[state.currentWeek];

            document.querySelectorAll('.qr-code-container').forEach(el => el.innerHTML = '');

            weekData.questions.forEach(q => {
                const url = `${baseUrl}?week=${state.currentWeek}&q=${q.id}`;
                const container = document.getElementById(`qr-${q.id}`);
                const urlDisplay = document.getElementById(`url-${q.id}`);
                
                if (container) {
                    new QRCode(container, {
                        text: url,
                        width: 120,
                        height: 120,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
                if (urlDisplay) urlDisplay.textContent = url;
            });

            // Generate Results QR
            const resultsUrl = `${baseUrl}?week=${state.currentWeek}&view=results`;
            const resultsContainer = document.getElementById('qr-results');
            const resultsUrlDisplay = document.getElementById('url-results');
            
            if (resultsContainer) {
                new QRCode(resultsContainer, {
                    text: resultsUrl,
                    width: 120,
                    height: 120,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
            if (resultsUrlDisplay) resultsUrlDisplay.textContent = resultsUrl;
        }

        // =============================================
        // EVENT HANDLERS
        // =============================================
        function attachEventListeners() {
            // Password submit
            const passwordBtn = document.getElementById('passwordSubmitBtn');
            const passwordInput = document.getElementById('passwordInput');
            if (passwordBtn && passwordInput) {
                const submitPassword = () => {
                    if (passwordInput.value === TEACHER_PASSWORD) {
                        state.isAuthenticated = true;
                        state.passwordError = false;
                        sessionStorage.setItem('teacher_auth', 'true');
                        render();
                    } else {
                        state.passwordError = true;
                        render();
                    }
                };
                passwordBtn.addEventListener('click', submitPassword);
                passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') submitPassword(); });
            }

            // Logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    state.isAuthenticated = false;
                    sessionStorage.removeItem('teacher_auth');
                    window.location.href = '?';
                });
            }

            // Week selector
            const weekSelect = document.getElementById('weekSelect');
            if (weekSelect) {
                weekSelect.addEventListener('change', (e) => {
                    state.currentWeek = parseInt(e.target.value);
                    state.responses = [];
                    const viewParam = state.view === 'qrcodes' ? 'qr' : state.view;
                    history.pushState({}, '', `?view=${viewParam}&week=${state.currentWeek}`);
                    render();
                });
            }

            // Nav tabs
            document.querySelectorAll('.nav-tab[data-view]').forEach(tab => {
                tab.addEventListener('click', () => {
                    state.view = tab.dataset.view;
                    const viewParam = state.view === 'qrcodes' ? 'qr' : state.view;
                    history.pushState({}, '', `?view=${viewParam}&week=${state.currentWeek}`);
                    render();
                });
            });

            // Student name
            const startBtn = document.getElementById('startQuizBtn');
            const nameInput = document.getElementById('studentNameInput');
            if (startBtn && nameInput) {
                const submitName = () => {
                    const name = nameInput.value.trim();
                    if (name) {
                        state.studentName = name;
                        localStorage.setItem('quiz_student_name', name);
                        if (state.view === 'results') {
                            loadStudentResults();
                        } else {
                            render();
                        }
                    }
                };
                startBtn.addEventListener('click', submitName);
                nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') submitName(); });
            }

            // Change name button (on results page)
            const changeNameBtn = document.getElementById('changeNameBtn');
            if (changeNameBtn) {
                changeNameBtn.addEventListener('click', () => {
                    state.studentName = '';
                    state.studentResults = [];
                    localStorage.removeItem('quiz_student_name');
                    render();
                });
            }

            // Options
            document.querySelectorAll('.option-item[data-clickable][data-option]').forEach(opt => {
                opt.addEventListener('click', () => {
                    const weekData = allQuizData[state.currentWeek];
                    const question = weekData.questions.find(q => q.id === state.currentQuestion);
                    const key = `${state.currentWeek}-${state.currentQuestion}`;
                    const optIndex = parseInt(opt.dataset.option);
                    
                    if (question.type === 'multiple') {
                        const current = state.selectedAnswers[key] || [];
                        state.selectedAnswers[key] = current.includes(optIndex) 
                            ? current.filter(i => i !== optIndex) 
                            : [...current, optIndex];
                    } else {
                        state.selectedAnswers[key] = optIndex;
                    }
                    render();
                });
            });

            document.querySelectorAll('.option-item[data-clickable][data-tf]').forEach(opt => {
                opt.addEventListener('click', () => {
                    const key = `${state.currentWeek}-${state.currentQuestion}`;
                    state.selectedAnswers[key] = opt.dataset.tf === 'true';
                    render();
                });
            });

            const fillInput = document.getElementById('fillBlankInput');
            if (fillInput) {
                fillInput.addEventListener('input', (e) => {
                    const key = `${state.currentWeek}-${state.currentQuestion}`;
                    state.selectedAnswers[key] = e.target.value;
                    const btn = document.getElementById('submitAnswerBtn');
                    if (btn) btn.disabled = !e.target.value.trim();
                });
            }

            // Submit answer
            const submitBtn = document.getElementById('submitAnswerBtn');
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    const weekData = allQuizData[state.currentWeek];
                    const question = weekData.questions.find(q => q.id === state.currentQuestion);
                    const key = `${state.currentWeek}-${state.currentQuestion}`;
                    const answer = state.selectedAnswers[key];
                    let isCorrect = false;

                    switch(question.type) {
                        case 'single':
                            isCorrect = answer === question.correct;
                            break;
                        case 'multiple':
                            isCorrect = Array.isArray(answer) && 
                                answer.length === question.correct.length &&
                                answer.every(a => question.correct.includes(a));
                            break;
                        case 'truefalse':
                            isCorrect = answer === question.correct;
                            break;
                        case 'fillblank':
                            isCorrect = question.correct.some(c => c.toLowerCase() === answer.trim().toLowerCase());
                            break;
                    }

                    state.submitted[key] = true;
                    saveResponse({
                        studentName: state.studentName,
                        questionId: state.currentQuestion,
                        answer: answer,
                        correct: isCorrect
                    });
                    render();
                });
            }

            // Clear responses
            const clearBtn = document.getElementById('clearBtn');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (confirm(`Clear ALL responses for Week ${state.currentWeek}? This cannot be undone.`)) {
                        clearWeekResponses();
                    }
                });
            }

            // QR generation
            const regenBtn = document.getElementById('regenerateQRBtn');
            if (regenBtn) {
                regenBtn.addEventListener('click', () => {
                    state.baseUrl = document.getElementById('baseUrlInput').value;
                    generateQRCodes();
                });
            }

            // Download QR
            document.querySelectorAll('.download-btn[data-qr]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const qrId = btn.dataset.qr;
                    const canvas = document.getElementById(`qr-${qrId}`)?.querySelector('canvas');
                    if (canvas) {
                        const link = document.createElement('a');
                        link.download = `week${state.currentWeek}-${qrId === 'results' ? 'results' : 'q' + qrId}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    }
                });
            });
        }

        // Initialize
        render();

        // If on results page and name is set, load results
        if (state.view === 'results' && state.studentName) {
            loadStudentResults();
        }

        window.addEventListener('popstate', () => { parseUrlParams(); render(); });
    </script>
</body>
</html>
